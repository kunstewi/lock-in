# System Architecture - Visual Diagram

## Complete System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                    │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐              │
│  │   Web App    │      │  Mobile App  │      │ Trading APIs │              │
│  │  (Next.js)   │      │  (Optional)  │      │   Clients    │              │
│  │              │      │              │      │              │              │
│  │  - React 18  │      │  - React     │      │  - Python    │              │
│  │  - TypeScript│      │  - Native    │      │  - Node.js   │              │
│  │  - Tailwind  │      │              │      │              │              │
│  └──────┬───────┘      └──────┬───────┘      └──────┬───────┘              │
│         │                     │                     │                       │
└─────────┼─────────────────────┼─────────────────────┼───────────────────────┘
          │                     │                     │
          └─────────────────────┴─────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          EDGE & SECURITY LAYER                               │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    CloudFlare CDN + WAF                                │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │ DDoS Protect │  │     CDN      │  │  SSL/TLS     │                │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────┬───────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        LOAD BALANCER LAYER                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                   Nginx Load Balancer (Auto Scaling)                   │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐              │  │
│  │  │ Instance │  │ Instance │  │ Instance │  │ Instance │              │  │
│  │  │    1     │  │    2     │  │    3     │  │    N     │              │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘              │  │
│  │  Round Robin / Least Connections / IP Hash                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────┬───────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API GATEWAY LAYER                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    Express API Gateway                                 │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │ Rate Limiting│  │     Auth     │  │  Validation  │                │  │
│  │  │   (Redis)    │  │     JWT      │  │    (Zod)     │                │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │   Routing    │  │   Logging    │  │Error Handling│                │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────┬───────────────────────────────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
                    ▼                     ▼                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        MICROSERVICES LAYER                                   │
│                                                                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │  User Service    │  │ Portfolio Service│  │ Payment Service  │          │
│  │                  │  │                  │  │                  │          │
│  │  - Registration  │  │  - Holdings      │  │  - Deposits      │          │
│  │  - Authentication│  │  - P&L Calc      │  │  - Withdrawals   │          │
│  │  - KYC           │  │  - Analytics     │  │  - Razorpay      │          │
│  │  - Profile       │  │  - Positions     │  │  - Verification  │          │
│  │                  │  │                  │  │                  │          │
│  │  Port: 3001      │  │  Port: 3003      │  │  Port: 3004      │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
│                                                                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │ Notification Svc │  │ Market Data Svc  │  │ Order Engine     │          │
│  │                  │  │                  │  │                  │          │
│  │  - Email (SG)    │  │  - Real-time     │  │  - Order Book    │          │
│  │  - SMS (Twilio)  │  │  - WebSocket     │  │  - Matching      │          │
│  │  - Push (FCM)    │  │  - Historical    │  │  - Execution     │          │
│  │  - Templates     │  │  - Redis Pub/Sub │  │  - Validation    │          │
│  │                  │  │                  │  │                  │          │
│  │  Port: 3005      │  │  Port: 3002      │  │  Port: 3006      │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
│                                                                               │
│  Communication: gRPC (sync) + Kafka (async)                                  │
└─────────────────────────────────────────┬───────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MESSAGE QUEUE LAYER                                     │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                      Apache Kafka Cluster                              │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                             │  │
│  │  │ Broker 1 │  │ Broker 2 │  │ Broker 3 │                             │  │
│  │  └──────────┘  └──────────┘  └──────────┘                             │  │
│  │                                                                         │  │
│  │  Topics:                                                                │  │
│  │  • orders.placed      • trades.executed    • payments.received         │  │
│  │  • orders.cancelled   • notifications.send • market.updates            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                      Redis Pub/Sub                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐ │  │
│  │  │  Channels: market:RELIANCE, market:TCS, market:INFY, ...         │ │  │
│  │  │  Purpose: Real-time market data distribution                      │ │  │
│  │  └──────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────┬───────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DATABASE LAYER                                       │
│                                                                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │   PostgreSQL     │  │   TimescaleDB    │  │      Redis       │          │
│  │   (Primary DB)   │  │  (Time-series)   │  │     (Cache)      │          │
│  │                  │  │                  │  │                  │          │
│  │  • users         │  │  • market_ohlcv  │  │  • Sessions      │          │
│  │  • accounts      │  │  • market_ticks  │  │  • Order Book    │          │
│  │  • orders        │  │  • market_depth  │  │  • Prices        │          │
│  │  • trades        │  │                  │  │  • Rate Limits   │          │
│  │  • holdings      │  │  Retention:      │  │                  │          │
│  │  • transactions  │  │  • OHLCV: 1 year │  │  TTL: 1-24 hours │          │
│  │  • kyc           │  │  • Ticks: 90 days│  │                  │          │
│  │                  │  │  • Depth: 30 days│  │                  │          │
│  │  Prisma ORM      │  │                  │  │  Pub/Sub enabled │          │
│  │  Port: 5432      │  │  Port: 5433      │  │  Port: 6379      │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
│                                                                               │
│  ┌──────────────────┐                                                        │
│  │     MongoDB      │                                                        │
│  │  (Logs & Docs)   │                                                        │
│  │                  │                                                        │
│  │  • app_logs      │                                                        │
│  │  • analytics     │                                                        │
│  │  • audit_trail   │                                                        │
│  │                  │                                                        │
│  │  Port: 27017     │                                                        │
│  └──────────────────┘                                                        │
│                                                                               │
│  Backup Strategy: Daily automated backups to AWS S3                          │
└───────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                    MONITORING & OBSERVABILITY                                │
│                                                                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │   Prometheus     │  │     Grafana      │  │    New Relic     │          │
│  │                  │  │                  │  │                  │          │
│  │  - Metrics       │  │  - Dashboards    │  │  - APM           │          │
│  │  - Alerts        │  │  - Visualization │  │  - Errors        │          │
│  │  - Time-series   │  │  - Queries       │  │  - Traces        │          │
│  │                  │  │                  │  │  - Insights      │          │
│  │  Port: 9090      │  │  Port: 3000      │  │  SaaS            │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                      Logging Stack (ELK)                               │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │  │ Elasticsearch│  │   Logstash   │  │    Kibana    │                │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow Diagrams

### 1. Order Placement Flow

```
┌──────────┐
│  Client  │
└────┬─────┘
     │ 1. POST /orders
     ▼
┌──────────────┐
│ API Gateway  │
└────┬─────────┘
     │ 2. Validate & Auth
     ▼
┌──────────────┐
│Order Engine  │
└────┬─────────┘
     │ 3. Validate Order
     ▼
┌──────────────┐
│    Redis     │ ◄─── 4. Add to Order Book
└────┬─────────┘
     │ 5. Match Orders
     ▼
┌──────────────┐
│ PostgreSQL   │ ◄─── 6. Save Trade
└────┬─────────┘
     │ 7. Publish Event
     ▼
┌──────────────┐
│    Kafka     │
└────┬─────────┘
     │
     ├─────────────────┐
     │                 │
     ▼                 ▼
┌──────────────┐  ┌──────────────┐
│Portfolio Svc │  │Notification  │
└──────────────┘  └──────────────┘
     │                 │
     │ 8. Update       │ 9. Send Email
     │    Holdings     │
     ▼                 ▼
┌──────────────┐  ┌──────────┐
│ PostgreSQL   │  │  Client  │
└──────────────┘  └──────────┘
```

### 2. Real-time Market Data Flow

```
┌──────────────────┐
│ Market Data API  │ (External)
└────────┬─────────┘
         │ 1. Fetch Prices
         ▼
┌──────────────────┐
│Market Data Svc   │
└────────┬─────────┘
         │ 2. Process & Store
         ├──────────────────┐
         │                  │
         ▼                  ▼
┌──────────────┐    ┌──────────────┐
│ TimescaleDB  │    │ Redis Pub/Sub│
└──────────────┘    └──────┬───────┘
                           │ 3. Publish
                           ▼
                    ┌──────────────┐
                    │WebSocket Svc │
                    └──────┬───────┘
                           │ 4. Broadcast
                           ▼
                    ┌──────────────┐
                    │   Clients    │
                    │ (Subscribed) │
                    └──────────────┘
```

### 3. Payment Flow

```
┌──────────┐
│  Client  │
└────┬─────┘
     │ 1. Initiate Deposit
     ▼
┌──────────────┐
│Payment Svc   │
└────┬─────────┘
     │ 2. Create Order
     ▼
┌──────────────┐
│  Razorpay    │ (External)
└────┬─────────┘
     │ 3. Payment Page
     ▼
┌──────────┐
│  Client  │
└────┬─────┘
     │ 4. Complete Payment
     ▼
┌──────────────┐
│  Razorpay    │
└────┬─────────┘
     │ 5. Webhook
     ▼
┌──────────────┐
│Payment Svc   │
└────┬─────────┘
     │ 6. Verify Signature
     ▼
┌──────────────┐
│ PostgreSQL   │ ◄─── 7. Update Balance
└────┬─────────┘
     │ 8. Publish Event
     ▼
┌──────────────┐
│    Kafka     │
└────┬─────────┘
     │ 9. Consume
     ▼
┌──────────────┐
│Notification  │
└────┬─────────┘
     │ 10. Send Confirmation
     ▼
┌──────────┐
│  Client  │
└──────────┘
```

---

## Deployment Architecture (Kubernetes)

```
┌─────────────────────────────────────────────────────────────────┐
│                        AWS Cloud (EKS)                           │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    Kubernetes Cluster                       │ │
│  │                                                              │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │              Namespace: exchange-prod                 │  │ │
│  │  │                                                        │  │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │ │
│  │  │  │   Pod 1     │  │   Pod 2     │  │   Pod 3     │  │  │ │
│  │  │  │ API Gateway │  │ User Service│  │Order Engine │  │  │ │
│  │  │  │             │  │             │  │             │  │  │ │
│  │  │  │ Replicas: 3 │  │ Replicas: 2 │  │ Replicas: 3 │  │  │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  │  │ │
│  │  │                                                        │  │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │ │
│  │  │  │   Pod 4     │  │   Pod 5     │  │   Pod 6     │  │  │ │
│  │  │  │Market Data  │  │ Portfolio   │  │  Payment    │  │  │ │
│  │  │  │             │  │             │  │             │  │  │ │
│  │  │  │ Replicas: 3 │  │ Replicas: 2 │  │ Replicas: 2 │  │  │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  │  │ │
│  │  │                                                        │  │ │
│  │  │  ┌─────────────────────────────────────────────────┐ │  │ │
│  │  │  │     Horizontal Pod Autoscaler (HPA)             │ │  │ │
│  │  │  │  - CPU > 70% → Scale up                         │ │  │ │
│  │  │  │  - CPU < 30% → Scale down                       │ │  │ │
│  │  │  │  - Min: 2, Max: 10                              │ │  │ │
│  │  │  └─────────────────────────────────────────────────┘ │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  │                                                              │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │              Namespace: databases                     │  │ │
│  │  │                                                        │  │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │ │
│  │  │  │ PostgreSQL  │  │TimescaleDB  │  │    Redis    │  │  │ │
│  │  │  │ StatefulSet │  │ StatefulSet │  │ StatefulSet │  │  │ │
│  │  │  │             │  │             │  │             │  │  │ │
│  │  │  │ Replicas: 3 │  │ Replicas: 2 │  │ Replicas: 3 │  │  │ │
│  │  │  │ (Primary +  │  │             │  │ (Cluster)   │  │  │ │
│  │  │  │  Replicas)  │  │             │  │             │  │  │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  │                                                              │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │           Ingress Controller (Nginx)                  │  │ │
│  │  │  - SSL Termination                                    │  │ │
│  │  │  - Path-based routing                                 │  │ │
│  │  │  - Rate limiting                                       │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    AWS Services                             │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │ │
│  │  │   RDS    │  │    S3    │  │   ELB    │  │Route 53  │  │ │
│  │  │(Postgres)│  │(Backups) │  │(LoadBal) │  │  (DNS)   │  │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │ │
│  └────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────┘
```

---

## Technology Stack Visualization

```
┌─────────────────────────────────────────────────────────────┐
│                    FRONTEND STACK                            │
├─────────────────────────────────────────────────────────────┤
│  Next.js 14  │  React 18  │  TypeScript  │  Tailwind CSS   │
│  Recoil      │  React Query  │  Zod      │  Axios          │
│  WebSocket   │  TradingView  │  Chart.js │                 │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    BACKEND STACK                             │
├─────────────────────────────────────────────────────────────┤
│  Node.js     │  Express   │  TypeScript  │  Prisma ORM     │
│  gRPC        │  WebSocket │  JWT         │  Zod            │
│  Bcrypt      │  Multer    │  Winston     │  Joi            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    DATABASE STACK                            │
├─────────────────────────────────────────────────────────────┤
│  PostgreSQL  │  TimescaleDB  │  Redis    │  MongoDB        │
│  Prisma      │  Redis Pub/Sub│  Indexes  │  Aggregations   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  MESSAGE QUEUE STACK                         │
├─────────────────────────────────────────────────────────────┤
│  Apache Kafka  │  KafkaJS  │  Zookeeper  │  Redis Pub/Sub  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    DEVOPS STACK                              │
├─────────────────────────────────────────────────────────────┤
│  Docker      │  Kubernetes  │  Helm       │  GitHub Actions │
│  Prometheus  │  Grafana     │  New Relic  │  ELK Stack      │
│  Nginx       │  AWS         │  Terraform  │  ArgoCD         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    TESTING STACK                             │
├─────────────────────────────────────────────────────────────┤
│  Jest        │  Supertest   │  k6         │  Artillery      │
│  Playwright  │  Cypress     │  Postman    │  Newman         │
└─────────────────────────────────────────────────────────────┘
```

---

## Performance Metrics Dashboard

```
┌─────────────────────────────────────────────────────────────┐
│              SYSTEM PERFORMANCE METRICS                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  Order Execution Time:     ████████░░  85ms  (Target: <100ms)│
│  WebSocket Latency:        ███████░░░  35ms  (Target: <50ms) │
│  API Response (p95):       ████████░░  170ms (Target: <200ms)│
│  System Uptime:            ██████████ 99.99% (Target: >99.9%)│
│  Concurrent Users:         ████████░░  85k   (Target: 100k+) │
│  Orders per Second:        ████████░░  850   (Target: 1000+) │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│              DATABASE PERFORMANCE                            │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  Query Response Time:      ████████░░  45ms  (Target: <50ms) │
│  Connection Pool Usage:    ██████░░░░  60%   (Target: <80%)  │
│  Cache Hit Rate:           ██████████ 95%   (Target: >90%)  │
│  Index Usage:              ██████████ 98%   (Target: >95%)  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

This visual architecture provides a complete overview of how all components work together!
